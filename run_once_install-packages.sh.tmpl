{{ if eq .chezmoi.os "linux" -}}
#!/bin/sh
# Portable CLI tools for dotfiles
# Skip if GRIEVER_INSTALL is set (griever handles packages)

if [ -n "$GRIEVER_INSTALL" ]; then
    echo "Skipping dotfiles package install (griever handles this)"
    exit 0
fi

{{ if eq .chezmoi.osRelease.id "arch" -}}
# Arch Linux
sudo pacman -S --needed --noconfirm \
  bat \
  direnv \
  fish \
  fzf \
  git \
  github-cli \
  man-db \
  neovim \
  ripgrep \
  tmux \
  zoxide

{{ else if eq .chezmoi.osRelease.id "ubuntu" -}}
# Ubuntu / Debian
export DEBIAN_FRONTEND=noninteractive

# Retry wrapper for apt commands that may fail due to lock contention
# (e.g. when Coder startup scripts run apt concurrently)
retry_apt() {
    local attempt=1
    local max_attempts=30
    while [ "$attempt" -le "$max_attempts" ]; do
        if "$@"; then
            return 0
        fi
        echo "apt command failed (attempt $attempt/$max_attempts), retrying in 2s..."
        attempt=$((attempt + 1))
        sleep 2
    done
    echo "apt command failed after $max_attempts attempts"
    return 1
}

# Add fish PPA for latest version
if ! command -v fish >/dev/null 2>&1; then
    sudo apt-add-repository -y --no-update ppa:fish-shell/release-3
fi

retry_apt sudo apt-get update -qq
retry_apt sudo apt-get install -y -qq \
  bat \
  direnv \
  fish \
  fzf \
  git \
  gh \
  man-db \
  ripgrep \
  tmux \
  zoxide

# bat is installed as batcat on Ubuntu - symlink it
if command -v batcat >/dev/null 2>&1 && ! command -v bat >/dev/null 2>&1; then
    sudo ln -sf "$(command -v batcat)" /usr/local/bin/bat
fi

# Install Neovim via AppImage (Ubuntu repos have old version)
if ! command -v nvim >/dev/null 2>&1; then
    curl -fsSL -o /tmp/nvim.appimage https://github.com/neovim/neovim/releases/download/stable/nvim-linux-x86_64.appimage
    chmod +x /tmp/nvim.appimage
    # Extract AppImage (works in containers without FUSE)
    cd /tmp && ./nvim.appimage --appimage-extract >/dev/null 2>&1
    sudo mv /tmp/squashfs-root /opt/nvim
    sudo ln -sf /opt/nvim/AppRun /usr/local/bin/nvim
    rm -f /tmp/nvim.appimage
fi

{{ end -}}
# Set fish as default shell (applies to all distros)
if [ "$(getent passwd "$(whoami)" | cut -d: -f7)" != "$(which fish)" ]; then
    sudo chsh -s "$(which fish)" "$(whoami)"
fi

# Install OpenCode
if ! command -v opencode >/dev/null 2>&1 && ! test -x "$HOME/.opencode/bin/opencode"; then
    curl -fsSL https://opencode.ai/install | bash -s -- --no-modify-path
    # Symlink to a standard PATH location
    sudo ln -sf "$HOME/.opencode/bin/opencode" /usr/local/bin/opencode
fi

echo "Portable CLI tools installed"
{{ end -}}
